heat_template_version: 2015-10-15

parameters:
  key_value:
    type: string
  config_host:
    type: string
  config_password:
    type: string
  volume_type:
    type: string
  public_net:
    type: string
  virtual_dns:
    type: string
  instance_zone:
    type: string
    default: nova
  instance_os:
    type: string
  instance_image_proxy:
    type: string
  instance_image_application:
    type: string
  instance_image_database:
    type: string
  instance_image_search:
    type: string
  instance_flavor_proxy:
    type: string
    default: m1.medium
  instance_flavor_application:
    type: string
    default: m1.large
  instance_flavor_database:
    type: string
    default: m1.large
  instance_flavor_search:
    type: string
    default: m1.medium
  prx01_name:
    type: string
    default: prx01.waterbear-dev.os.st.sk
  app01_name:
    type: string
    default: app01.waterbear-dev.os.st.sk
  app02_name:
    type: string
    default: app02.waterbear-dev.os.st.sk
  app03_name:
    type: string
    default: app03.waterbear-dev.os.st.sk
  dbs01_name:
    type: string
    default: dbs01.waterbear-dev.os.st.sk
  src01_name:
    type: string
    default: src01.waterbear-dev.os.st.sk
  prx01_address:
    type: string
    default: 172.16.10.100
  app01_address:
    type: string
    default: 172.16.10.101
  app02_address:
    type: string
    default: 172.16.10.102
  app03_address:
    type: string
    default: 172.16.10.103
  dbs01_address:
    type: string
    default: 172.16.10.110
  src01_address:
    type: string
    default: 172.16.10.111

resources:
  waterbear_network:
    type: ITC::Waterbear::BaseNetwork
    properties:
      stack_name: { get_param: "OS::stack_name" }
      key_value: { get_param: key_value }
      public_net: { get_param: public_net }
  waterbear_proxy:
    type: ITC::Waterbear::ProxyInstance
    depends_on: waterbear_application
    properties:
      public_net: { get_param: public_net }
      private_net: { get_attr: [waterbear_network, private_net_name] }
      key_pair: { get_param: "OS::stack_name" }
      security_group: { get_attr: [waterbear_network, security_group] }
      config_host: { get_param: config_host }
      config_password: { get_param: config_password }
      instance_os: { get_param: instance_os }
      instance_flavor: { get_param: instance_flavor_proxy }
      instance_image: { get_param: instance_image_proxy }
      instance_zone:  { get_param: instance_zone }
      instance_name: { get_param: prx01_name }
      instance_address: { get_param: prx01_address }
      volume_type: { get_param: volume_type }
      virtual_dns: { get_param: virtual_dns }
  waterbear_application:
    type: ITC::Waterbear::ApplicationCluster
    depends_on: waterbear_database
    properties:
      public_net: { get_param: public_net }
      private_net: { get_attr: [waterbear_network, private_net_name] }
      key_pair: { get_param: "OS::stack_name" }
      security_group: { get_attr: [waterbear_network, security_group] }
      config_host: { get_param: config_host }
      config_password: { get_param: config_password }
      instance_os: { get_param: instance_os }
      instance_flavor: { get_param: instance_flavor_application }
      instance_image: { get_param: instance_image_application }
      instance_zone:  { get_param: instance_zone }
      instance01_name: { get_param: app01_name }
      instance02_name: { get_param: app02_name }
      instance03_name: { get_param: app03_name }
      instance01_address: { get_param: app01_address }
      instance02_address: { get_param: app02_address }
      instance03_address: { get_param: app03_address }
      volume_type: { get_param: volume_type }
      virtual_dns: { get_param: virtual_dns }
      cluster_name: 'wb-app'
  waterbear_database:
    type: ITC::Waterbear::DatabaseInstance
    depends_on: waterbear_network
    properties:
      public_net: { get_param: public_net }
      private_net: { get_attr: [waterbear_network, private_net_name] }
      key_pair: { get_param: "OS::stack_name" }
      security_group: { get_attr: [waterbear_network, security_group] }
      config_host: { get_param: config_host }
      config_password: { get_param: config_password }
      instance_os: { get_param: instance_os }
      instance_flavor: { get_param: instance_flavor_database }
      instance_image: { get_param: instance_image_database }
      instance_zone:  { get_param: instance_zone }
      instance_name: { get_param: dbs01_name }
      instance_address: { get_param: dbs01_address }
      volume_type: { get_param: volume_type }
      virtual_dns: { get_param: virtual_dns }
  waterbear_search:
    type: ITC::Waterbear::SearchInstance
    depends_on: waterbear_network
    properties:
      public_net: { get_param: public_net }
      private_net: { get_attr: [waterbear_network, private_net_name] }
      key_pair: { get_param: "OS::stack_name" }
      security_group: { get_attr: [waterbear_network, security_group] }
      config_host: { get_param: config_host }
      config_password: { get_param: config_password }
      instance_os: { get_param: instance_os }
      instance_flavor: { get_param: instance_flavor_search }
      instance_image: { get_param: instance_image_search }
      instance_zone:  { get_param: instance_zone }
      instance_name: { get_param: src01_name }
      instance_address: { get_param: src01_address }
      volume_type: { get_param: volume_type }
      virtual_dns: { get_param: virtual_dns }

outputs:
  waterbear_public_address:
    value: { get_attr: [waterbear_proxy, public_address] }
    description: "Public IP address of the Waterbear proxy"
